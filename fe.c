#include "fe.h"

void fe_squeeze(fe z)
{
    // Interleave two carry chains (8 rounds):
    //   - a: z[0] -> z[1] -> z[2] -> z[3] -> z[4]  -> z[5]  -> z[6] -> z[7]
    //   - b: z[6] -> z[7] -> z[8] -> z[9] -> z[10] -> z[11] -> z[0] -> z[1]
    //
    // Precondition:
    //   - For all limbs x in z : |x| <= 0.99 * 2^53
    //
    // Postcondition:
    //   - All significands fit in b + 1 bits (b = 22, 21, 21, etc.)

    double t0, t1;
    t0 = z[0] + 0x3p73 - 0x3p73; // Round 1a
    z[0] -= t0;
    z[1] += t0;
    t1 = z[6] + 0x3p200 - 0x3p200; // Round 1b
    z[6] -= t1;
    z[7] += t1;
    t0 = z[1] + 0x3p94 - 0x3p94; // Round 2a
    z[1] -= t0;
    z[2] += t0;
    t1 = z[7] + 0x3p221 - 0x3p221; // Round 2b
    z[7] -= t1;
    z[8] += t1;
    t0 = z[2] + 0x3p115 - 0x3p115; // Round 3a
    z[2] -= t0;
    z[3] += t0;
    t1 = z[8] + 0x3p243 - 0x3p243; // Round 3b
    z[8] -= t1;
    z[9] += t1;
    t0 = z[3] + 0x3p136 - 0x3p136; // Round 4a
    z[3] -= t0;
    z[4] += t0;
    t1 = z[9] + 0x3p264 - 0x3p264; // Round 4b
    z[9] -= t1;
    z[10] += t1;
    t0 = z[4] + 0x3p158 - 0x3p158; // Round 5a
    z[4] -= t0;
    z[5] += t0;
    t1 = z[10] + 0x3p285 - 0x3p285; // Round 5b
    z[10] -= t1;
    z[11] += t1;
    t0 = z[5] + 0x3p179 - 0x3p179; // Round 6a
    z[5] -= t0;
    z[6] += t0;
    t1 = z[11] + 0x3p306 - 0x3p306; // Round 6b
    z[11] -= t1;
    z[0] += 0x13p-255 * t1; // 19 * 2^-255
    t0 = z[6] + 0x3p200 - 0x3p200; // Round 7a
    z[6] -= t0;
    z[7] += t0;
    t1 = z[0] + 0x3p73 - 0x3p73; // Round 7b
    z[0] -= t1;
    z[1] += t1;
    t0 = z[7] + 0x3p221 - 0x3p221; // Round 8a
    z[7] -= t0;
    z[8] += t0;
    t1 = z[1] + 0x3p94 - 0x3p94; // Round 8b
    z[1] -= t1;
    z[2] += t1;
}

void fe_mul(fe h, const fe f, const fe g)
{
    // Precompute reduced g values
    const double  g1_19 = 0x13p-255 * g[ 1];
    const double  g2_19 = 0x13p-255 * g[ 2];
    const double  g3_19 = 0x13p-255 * g[ 3];
    const double  g4_19 = 0x13p-255 * g[ 4];
    const double  g5_19 = 0x13p-255 * g[ 5];
    const double  g6_19 = 0x13p-255 * g[ 6];
    const double  g7_19 = 0x13p-255 * g[ 7];
    const double  g8_19 = 0x13p-255 * g[ 8];
    const double  g9_19 = 0x13p-255 * g[ 9];
    const double g10_19 = 0x13p-255 * g[10];
    const double g11_19 = 0x13p-255 * g[11];

    // Round  1/12
    for (unsigned int i = 0; i < 12; i++) h[i] = f[0] * g[i];

    // Round  2/12
    h[ 0] += f[ 1] * g11_19;
    h[ 1] += f[ 1] * g[ 0];
    h[ 2] += f[ 1] * g[ 1];
    h[ 3] += f[ 1] * g[ 2];
    h[ 4] += f[ 1] * g[ 3];
    h[ 5] += f[ 1] * g[ 4];
    h[ 6] += f[ 1] * g[ 5];
    h[ 7] += f[ 1] * g[ 6];
    h[ 8] += f[ 1] * g[ 7];
    h[ 9] += f[ 1] * g[ 8];
    h[10] += f[ 1] * g[ 9];
    h[11] += f[ 1] * g[10];

    // Round  3/12
    h[ 0] += f[ 2] * g10_19;
    h[ 1] += f[ 2] * g11_19;
    h[ 2] += f[ 2] * g[ 0];
    h[ 3] += f[ 2] * g[ 1];
    h[ 4] += f[ 2] * g[ 2];
    h[ 5] += f[ 2] * g[ 3];
    h[ 6] += f[ 2] * g[ 4];
    h[ 7] += f[ 2] * g[ 5];
    h[ 8] += f[ 2] * g[ 6];
    h[ 9] += f[ 2] * g[ 7];
    h[10] += f[ 2] * g[ 8];
    h[11] += f[ 2] * g[ 9];

    // Round  4/12
    h[ 0] += f[ 3] * g9_19;
    h[ 1] += f[ 3] * g10_19;
    h[ 2] += f[ 3] * g11_19;
    h[ 3] += f[ 3] * g[ 0];
    h[ 4] += f[ 3] * g[ 1];
    h[ 5] += f[ 3] * g[ 2];
    h[ 6] += f[ 3] * g[ 3];
    h[ 7] += f[ 3] * g[ 4];
    h[ 8] += f[ 3] * g[ 5];
    h[ 9] += f[ 3] * g[ 6];
    h[10] += f[ 3] * g[ 7];
    h[11] += f[ 3] * g[ 8];

    // Round  5/12
    h[ 0] += f[ 4] * g8_19;
    h[ 1] += f[ 4] * g9_19;
    h[ 2] += f[ 4] * g10_19;
    h[ 3] += f[ 4] * g11_19;
    h[ 4] += f[ 4] * g[ 0];
    h[ 5] += f[ 4] * g[ 1];
    h[ 6] += f[ 4] * g[ 2];
    h[ 7] += f[ 4] * g[ 3];
    h[ 8] += f[ 4] * g[ 4];
    h[ 9] += f[ 4] * g[ 5];
    h[10] += f[ 4] * g[ 6];
    h[11] += f[ 4] * g[ 7];

    // Round  6/12
    h[ 0] += f[ 5] * g7_19;
    h[ 1] += f[ 5] * g8_19;
    h[ 2] += f[ 5] * g9_19;
    h[ 3] += f[ 5] * g10_19;
    h[ 4] += f[ 5] * g11_19;
    h[ 5] += f[ 5] * g[ 0];
    h[ 6] += f[ 5] * g[ 1];
    h[ 7] += f[ 5] * g[ 2];
    h[ 8] += f[ 5] * g[ 3];
    h[ 9] += f[ 5] * g[ 4];
    h[10] += f[ 5] * g[ 5];
    h[11] += f[ 5] * g[ 6];

    // Round  7/12
    h[ 0] += f[ 6] * g6_19;
    h[ 1] += f[ 6] * g7_19;
    h[ 2] += f[ 6] * g8_19;
    h[ 3] += f[ 6] * g9_19;
    h[ 4] += f[ 6] * g10_19;
    h[ 5] += f[ 6] * g11_19;
    h[ 6] += f[ 6] * g[ 0];
    h[ 7] += f[ 6] * g[ 1];
    h[ 8] += f[ 6] * g[ 2];
    h[ 9] += f[ 6] * g[ 3];
    h[10] += f[ 6] * g[ 4];
    h[11] += f[ 6] * g[ 5];

    // Round  8/12
    h[ 0] += f[ 7] * g5_19;
    h[ 1] += f[ 7] * g6_19;
    h[ 2] += f[ 7] * g7_19;
    h[ 3] += f[ 7] * g8_19;
    h[ 4] += f[ 7] * g9_19;
    h[ 5] += f[ 7] * g10_19;
    h[ 6] += f[ 7] * g11_19;
    h[ 7] += f[ 7] * g[ 0];
    h[ 8] += f[ 7] * g[ 1];
    h[ 9] += f[ 7] * g[ 2];
    h[10] += f[ 7] * g[ 3];
    h[11] += f[ 7] * g[ 4];

    // Round  9/12
    h[ 0] += f[ 8] * g4_19;
    h[ 1] += f[ 8] * g5_19;
    h[ 2] += f[ 8] * g6_19;
    h[ 3] += f[ 8] * g7_19;
    h[ 4] += f[ 8] * g8_19;
    h[ 5] += f[ 8] * g9_19;
    h[ 6] += f[ 8] * g10_19;
    h[ 7] += f[ 8] * g11_19;
    h[ 8] += f[ 8] * g[ 0];
    h[ 9] += f[ 8] * g[ 1];
    h[10] += f[ 8] * g[ 2];
    h[11] += f[ 8] * g[ 3];

    // Round 10/12
    h[ 0] += f[ 9] * g3_19;
    h[ 1] += f[ 9] * g4_19;
    h[ 2] += f[ 9] * g5_19;
    h[ 3] += f[ 9] * g6_19;
    h[ 4] += f[ 9] * g7_19;
    h[ 5] += f[ 9] * g8_19;
    h[ 6] += f[ 9] * g9_19;
    h[ 7] += f[ 9] * g10_19;
    h[ 8] += f[ 9] * g11_19;
    h[ 9] += f[ 9] * g[ 0];
    h[10] += f[ 9] * g[ 1];
    h[11] += f[ 9] * g[ 2];

    // Round 11/12
    h[ 0] += f[10] * g2_19;
    h[ 1] += f[10] * g3_19;
    h[ 2] += f[10] * g4_19;
    h[ 3] += f[10] * g5_19;
    h[ 4] += f[10] * g6_19;
    h[ 5] += f[10] * g7_19;
    h[ 6] += f[10] * g8_19;
    h[ 7] += f[10] * g9_19;
    h[ 8] += f[10] * g10_19;
    h[ 9] += f[10] * g11_19;
    h[10] += f[10] * g[ 0];
    h[11] += f[10] * g[ 1];

    // Round 12/12
    h[ 0] += f[11] * g1_19;
    h[ 1] += f[11] * g2_19;
    h[ 2] += f[11] * g3_19;
    h[ 3] += f[11] * g4_19;
    h[ 4] += f[11] * g5_19;
    h[ 5] += f[11] * g6_19;
    h[ 6] += f[11] * g7_19;
    h[ 7] += f[11] * g8_19;
    h[ 8] += f[11] * g9_19;
    h[ 9] += f[11] * g10_19;
    h[10] += f[11] * g11_19;
    h[11] += f[11] * g[ 0];

    fe_squeeze(h);
}

void fe_square(fe h, const fe f)
{
    fe_mul(h, f, f);
}
